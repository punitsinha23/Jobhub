{% extends "base.html" %}

{% block title %}JobHub Chatbot | JobHub{% endblock %}

{% block content %}
<style>
  html, body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f0f2f5; 
    color: #000;
    min-height: 100%; 
  }

  #chatbox {
    display: flex;
    flex-direction: column;
    height: 80vh;
    width: 100%;
    max-width: 1200px;
    margin: 20px auto 40px auto;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  #header {
    padding: 15px;
    text-align: center;
    font-weight: bold;
    font-size: 1.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #000;
  }

  #header .brand { color: black; }
  #header .chatbot { color: white; margin-left: 8px; }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f9f9f9;
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
  }

  #placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #888;
    text-align: center;
    font-size: 1.2rem;
    pointer-events: none;
  }

  .message {
    padding: 12px 16px;
    border-radius: 20px;
    max-width: 70%;
    word-wrap: break-word;
    font-size: 1rem;
  }

  .user {
    background-color: #d0e6ff;
    align-self: flex-end;
    color: #000;
  }

  .bot {
    background-color: #e2f7e1;
    align-self: flex-start;
    white-space: pre-wrap;
    color: #000;
  }

  #inputArea {
    display: flex;
    padding: 12px 15px;
    background: #fff;
    border-top: 1px solid #ddd;
  }

  #userInput {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 20px;
    outline: none;
    font-size: 1rem;
    background: #fff;
    color: #000;
  }

  #userInput::placeholder {
    color: #888;
  }

  #sendBtn {
    background-color: #ff8c00;
    border: none;
    color: white;
    padding: 0 20px;
    margin-left: 10px;
    cursor: pointer;
    font-weight: bold;
    border-radius: 20px;
    transition: background 0.2s;
  }

  #sendBtn:hover {
    background-color: #e07b00;
  }

  .bot-card {
    background: #e2f7e1;
    padding: 10px 15px;
    border-radius: 12px;
    word-wrap: break-word;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .bot-card a {
  color: white;
  background-color: #ff8c00;
  padding: 5px 10px;
  border-radius: 12px;
  text-decoration: none;
  display: inline-block;
  margin-top: 5px;
}

.bot-card a:hover {
  background-color: #e07b00;
}

</style>

<div id="chatbox">
  <div id="messages">
    <div id="placeholder">Start a conversation with JobHub Chatbot</div>
  </div>

  <div id="inputArea">
    <input type="text" id="userInput" placeholder="Type your message..." />
    <button id="sendBtn" onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
function markdownToHTML(text) {
  text = text.replace(/^### (.*$)/gim, '<b>$1</b><br>');
  text = text.replace(/^## (.*$)/gim, '<b>$1</b><br>');
  text = text.replace(/^# (.*$)/gim, '<b>$1</b><br>');
  text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
  text = text.replace(/\*(.*?)\*/g, '<i>$1</i>');
  text = text.replace(/\n/g, '<br>');
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
  text = text.replace(/\n/g, '<br>');
  return text;
}

async function sendMessage() {
  const input = document.getElementById("userInput");
  const messages = document.getElementById("messages");
  const placeholder = document.getElementById("placeholder");

  if (!input.value.trim()) return;
  if (placeholder) placeholder.style.display = 'none';

  const userMessage = document.createElement("div");
  userMessage.className = "message user";
  userMessage.textContent = input.value;
  messages.appendChild(userMessage);

  const userText = input.value;
  input.value = "";
  input.focus();

  const botMessage = document.createElement("div");
  botMessage.className = "message bot";
  messages.appendChild(botMessage);
  messages.scrollTop = messages.scrollHeight;

  const response = await fetch("{% url 'chat' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: userText })
  });

  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });

    botMessage.innerHTML = `<div class="bot-card">${markdownToHTML(buffer)}</div>`;
    messages.scrollTop = messages.scrollHeight;
  }
}
</script>
{% endblock %}
